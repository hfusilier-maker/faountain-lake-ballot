<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fountain Lake School District - Voter Database</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3MsI4xd2u8ZfvIjRZWsX5bzKvxVzUFuo&libraries=visualization"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        #map { height: 600px; width: 100%; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        const SALINE_SHEET_ID = '13Ot79wlChxVJqenZWGgl4uO9frQyDHd-DIJ_xGFbOrU';
        const SALINE_SHEET_NAME = 'Ft Lake_Saline voters';
        const GARLAND_SHEET_ID = '1DI5wpYUJu7EGIb-VuStKUdfpSRbcEWp4heFcN1f4eG0';
        const GARLAND_SHEET_NAME = 'Sheet1';
        const PARENT_SHEET_ID = '1CRJV-1LfOhIH_nlTMrfe7uaa9VDv4v2UhQG-wrWQMV0';
        const PARENT_SHEET_NAME = 'Sheet1';
        
        const App = {
            voterData: [],
            voterIndex: {}, // Fast lookup index
            parentData: [],
            filteredData: [],
            searchTerm: '',
            countyFilter: 'all',
            registeredFilter: 'all',
            viewMode: 'voters',
            loading: true,
            loadingProgress: 0,
            loadingMessage: 'Initializing...',
            map: null,
            markers: [],
            markerClusterer: null,
            heatmap: null,
            showHeatmap: false,
            mapFilter: 'all', // 'all', 'registered', 'unregistered'
            stats: {
                totalVoters: 0,
                salineVoters: 0,
                garlandVoters: 0,
                registeredParents: 0,
                unregisteredParents: 0,
                totalParents: 0
            },

            // String similarity function (Levenshtein distance)
            stringSimilarity(str1, str2) {
                if (!str1 || !str2) return 0;
                if (str1 === str2) return 100;
                
                const len1 = str1.length;
                const len2 = str2.length;
                
                // If one string is empty, similarity is 0
                if (len1 === 0 || len2 === 0) return 0;
                
                // Create distance matrix
                const matrix = [];
                for (let i = 0; i <= len1; i++) {
                    matrix[i] = [i];
                }
                for (let j = 0; j <= len2; j++) {
                    matrix[0][j] = j;
                }
                
                // Calculate Levenshtein distance
                for (let i = 1; i <= len1; i++) {
                    for (let j = 1; j <= len2; j++) {
                        const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j] + 1,      // deletion
                            matrix[i][j - 1] + 1,      // insertion
                            matrix[i - 1][j - 1] + cost // substitution
                        );
                    }
                }
                
                const distance = matrix[len1][len2];
                const maxLen = Math.max(len1, len2);
                const similarity = ((maxLen - distance) / maxLen) * 100;
                
                return Math.round(similarity);
            },

            // Geocode an address to lat/lng
            async geocodeAddress(address, cityStateZip) {
                const fullAddress = `${address}, ${cityStateZip}`;
                
                try {
                    const geocoder = new google.maps.Geocoder();
                    return new Promise((resolve, reject) => {
                        geocoder.geocode({ address: fullAddress }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                resolve({
                                    lat: results[0].geometry.location.lat(),
                                    lng: results[0].geometry.location.lng()
                                });
                            } else {
                                resolve(null);
                            }
                        });
                    });
                } catch (error) {
                    console.error('Geocoding error:', error);
                    return null;
                }
            },

            // Initialize the map
            initMap() {
                if (!this.map) {
                    // Center on Fountain Lake School District: 4207 Park Avenue, Hot Springs, AR 71901
                    const center = { lat: 34.5740735, lng: -92.9866302 };
                    
                    this.map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 13,
                        center: center,
                        mapTypeControl: true,
                        streetViewControl: false,
                        fullscreenControl: true,
                    });
                    
                    // Add a marker for the school
                    new google.maps.Marker({
                        position: center,
                        map: this.map,
                        title: 'Fountain Lake School District',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#7c3aed',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 3,
                        },
                        label: {
                            text: 'üè´',
                            fontSize: '20px',
                        }
                    });
                }
                
                this.updateMapMarkers();
            },

            // Update markers on the map
            async updateMapMarkers() {
                // Clear existing markers
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];
                
                // Filter parents based on mapFilter
                let parentsToShow = this.parentData;
                if (this.mapFilter === 'registered') {
                    parentsToShow = this.parentData.filter(p => p.isRegistered);
                } else if (this.mapFilter === 'unregistered') {
                    parentsToShow = this.parentData.filter(p => !p.isRegistered);
                }
                
                // Add markers for parents (limit to first 200 for performance)
                const maxMarkers = 200;
                const parentsToMap = parentsToShow.slice(0, maxMarkers);
                
                for (const parent of parentsToMap) {
                    const coords = await this.geocodeAddress(parent.fullAddress, parent.cityStateZip);
                    
                    if (coords) {
                        const icon = {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: parent.isRegistered ? 
                                (parent.matchConfidence >= 95 ? '#16a34a' : '#eab308') : 
                                '#dc2626',
                            fillOpacity: 0.8,
                            strokeColor: '#ffffff',
                            strokeWeight: 2,
                        };
                        
                        const marker = new google.maps.Marker({
                            position: coords,
                            map: this.map,
                            icon: icon,
                            title: `${parent.firstName} ${parent.lastName}`
                        });
                        
                        // Add info window
                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div style="padding: 8px; max-width: 250px;">
                                    <h3 style="font-weight: bold; margin-bottom: 8px;">${parent.firstName} ${parent.lastName}</h3>
                                    <p style="font-size: 12px; margin: 4px 0;"><strong>Status:</strong> ${parent.isRegistered ? '‚úì Registered' : '‚úó Not Registered'}</p>
                                    <p style="font-size: 12px; margin: 4px 0;"><strong>Address:</strong> ${parent.fullAddress}</p>
                                    <p style="font-size: 12px; margin: 4px 0;">${parent.cityStateZip}</p>
                                    ${parent.phone ? `<p style="font-size: 12px; margin: 4px 0;"><strong>Phone:</strong> ${parent.phone}</p>` : ''}
                                    ${parent.email ? `<p style="font-size: 12px; margin: 4px 0;"><strong>Email:</strong> ${parent.email}</p>` : ''}
                                    ${parent.matchMethod ? `<p style="font-size: 11px; margin: 4px 0; color: #666;"><em>${parent.matchMethod}</em></p>` : ''}
                                </div>
                            `
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(this.map, marker);
                        });
                        
                        this.markers.push(marker);
                    }
                }
                
                // Update heatmap
                this.updateHeatmap();
            },

            // Update heatmap overlay
            updateHeatmap() {
                // Remove existing heatmap
                if (this.heatmap) {
                    this.heatmap.setMap(null);
                }
                
                if (!this.showHeatmap) return;
                
                // Create heatmap data
                const heatmapData = [];
                const parentsToShow = this.mapFilter === 'unregistered' 
                    ? this.parentData.filter(p => !p.isRegistered)
                    : this.parentData;
                
                this.markers.forEach((marker, index) => {
                    if (index < parentsToShow.length) {
                        const parent = parentsToShow[index];
                        if (this.mapFilter === 'unregistered' && !parent.isRegistered) {
                            heatmapData.push({
                                location: marker.getPosition(),
                                weight: 2
                            });
                        } else if (this.mapFilter === 'all') {
                            heatmapData.push({
                                location: marker.getPosition(),
                                weight: parent.isRegistered ? 0.5 : 2
                            });
                        }
                    }
                });
                
                this.heatmap = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    radius: 30,
                    opacity: 0.6
                });
                
                this.heatmap.setMap(this.map);
            },

            toggleHeatmap() {
                this.showHeatmap = !this.showHeatmap;
                this.updateHeatmap();
                this.render();
            },

            setMapFilter(filter) {
                this.mapFilter = filter;
                if (this.viewMode === 'map') {
                    this.updateMapMarkers();
                }
                this.render();
            },

            async init() {
                this.loadingProgress = 10;
                this.loadingMessage = 'Loading Saline County voters...';
                this.render();
                
                await this.loadSalineData();
                
                this.loadingProgress = 40;
                this.loadingMessage = 'Loading Garland County voters...';
                this.render();
                
                await this.loadGarlandData();
                
                this.loadingProgress = 70;
                this.loadingMessage = 'Loading parent data...';
                this.render();
                
                await this.loadParentData();
                
                this.loadingProgress = 80;
                this.loadingMessage = 'Building address index...';
                this.render();
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 300));
                
                this.loadingProgress = 85;
                this.loadingMessage = 'Matching parents to voters...';
                this.render();
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 300));
                
                this.loadingProgress = 92;
                this.loadingMessage = 'Calculating registration rates...';
                this.render();
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 300));
                
                this.loadingProgress = 98;
                this.loadingMessage = 'Finalizing data...';
                this.render();
                
                // Small delay to show final progress
                await new Promise(resolve => setTimeout(resolve, 300));
                
                this.loadingProgress = 100;
                this.loadingMessage = 'Complete!';
                this.loading = false;
                this.render();
            },

            async loadSalineData() {
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${SALINE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SALINE_SHEET_NAME)}`;
                    
                    const response = await fetch(url);
                    const csvText = await response.text();
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const salineVoters = results.data.map((row, index) => {
                                const age = this.calculateAge(row.date_of_birth);
                                const fullAddress = this.buildAddress(
                                    row.text_registrant_res_street_nbr,
                                    row.text_street_name,
                                    row.text_res_city,
                                    row.cde_res_state,
                                    row.text_res_zip
                                );
                                
                                return {
                                    id: index,
                                    county: 'Saline',
                                    firstName: row.text_name_first || '',
                                    middleName: row.text_name_middle || '',
                                    lastName: row.text_name_last || '',
                                    fullAddress: fullAddress,
                                    status: row.cde_registrant_status || 'N/A',
                                    age: age,
                                    precinct: row.precinct_text_name || 'N/A',
                                    dob: row.date_of_birth || '',
                                    ...row
                                };
                            });
                            this.voterData = [...this.voterData.filter(v => v.county !== 'Saline'), ...salineVoters];
                            this.buildVoterIndex();
                            this.updateStats();
                            this.applyFilters();
                        },
                        error: (error) => {
                            console.error('Error parsing Saline CSV:', error);
                        }
                    });
                } catch (error) {
                    console.error('Error loading Saline Google Sheet:', error);
                }
            },

            buildVoterIndex() {
                // Build fast lookup index: key = "streetNumber", value = array of matching voters
                // ZIP code removed to be more forgiving with data quality issues
                this.voterIndex = {};
                
                for (const voter of this.voterData) {
                    const parsed = this.parseVoterAddress(voter);
                    if (parsed.streetNumber) {
                        const key = parsed.streetNumber;
                        if (!this.voterIndex[key]) {
                            this.voterIndex[key] = [];
                        }
                        this.voterIndex[key].push({
                            voter: voter,
                            parsed: parsed
                        });
                    }
                }
            },

            async loadGarlandData() {
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${GARLAND_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(GARLAND_SHEET_NAME)}`;
                    
                    const response = await fetch(url);
                    const csvText = await response.text();
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const garlandVoters = results.data.map((row, index) => {
                                const age = this.calculateAge(row.date_of_birth);
                                const fullAddress = this.buildAddress(
                                    row.text_res_address_nbr,
                                    row.text_street_name,
                                    row.text_mail_city,
                                    row.cde_mail_state,
                                    row.text_mail_zip
                                );
                                
                                return {
                                    id: 10000 + index,
                                    county: 'Garland',
                                    firstName: row.text_name_first || '',
                                    middleName: row.text_name_middle || '',
                                    lastName: row.text_name_last || '',
                                    fullAddress: fullAddress,
                                    status: 'N/A',
                                    age: age,
                                    precinct: row.precinct_text_name || 'N/A',
                                    dob: row.date_of_birth || '',
                                    ...row
                                };
                            });
                            this.voterData = [...this.voterData.filter(v => v.county !== 'Garland'), ...garlandVoters];
                            this.buildVoterIndex();
                            this.updateStats();
                            this.applyFilters();
                        },
                        error: (error) => {
                            console.error('Error parsing Garland CSV:', error);
                        }
                    });
                } catch (error) {
                    console.error('Error loading Garland Google Sheet:', error);
                }
            },

            calculateAge(dob) {
                if (!dob) return 'N/A';
                try {
                    const birthDate = new Date(dob);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    return age > 0 && age < 120 ? age : 'N/A';
                } catch (e) {
                    return 'N/A';
                }
            },

            buildAddress(streetNbr, streetName, city, state, zip) {
                const parts = [];
                if (streetNbr) parts.push(streetNbr);
                if (streetName) parts.push(streetName);
                
                const streetAddress = parts.join(' ');
                const cityStateZip = [city, state, zip].filter(Boolean).join(', ');
                
                return [streetAddress, cityStateZip].filter(Boolean).join(', ') || 'N/A';
            },

            async loadParentData() {
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${PARENT_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(PARENT_SHEET_NAME)}`;
                    
                    const response = await fetch(url);
                    const csvText = await response.text();
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            this.matchParentsToVoters(results.data);
                        },
                        error: (error) => {
                            console.error('Error parsing Parent CSV:', error);
                        }
                    });
                } catch (error) {
                    console.error('Error loading Parent Google Sheet:', error);
                }
            },

            updateStats() {
                const registeredParents = this.parentData.filter(p => p.isRegistered).length;
                this.stats = {
                    totalVoters: this.voterData.length,
                    salineVoters: this.voterData.filter(v => v.county === 'Saline').length,
                    garlandVoters: this.voterData.filter(v => v.county === 'Garland').length,
                    registeredParents: registeredParents,
                    unregisteredParents: this.parentData.length - registeredParents,
                    totalParents: this.parentData.length
                };
            },

            async handleGarlandFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                this.loading = true;
                this.render();

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
                        
                        const garlandData = jsonData.map((row, index) => ({
                            id: this.voterData.length + index,
                            county: 'Garland',
                            ...row
                        }));

                        this.voterData = [...this.voterData.filter(v => v.county === 'Saline'), ...garlandData];
                        
                        if (this.parentData.length > 0) {
                            this.matchParentsToVoters();
                        }
                        
                        this.updateStats();
                        this.applyFilters();
                        this.loading = false;
                        this.render();
                    } catch (error) {
                        console.error('Error processing file:', error);
                        alert('Error processing file: ' + error.message);
                        this.loading = false;
                        this.render();
                    }
                };
                reader.readAsArrayBuffer(file);
            },

            handleParentFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                this.loading = true;
                this.render();

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
                        
                        this.matchParentsToVoters(jsonData);
                        this.loading = false;
                        this.render();
                    } catch (error) {
                        console.error('Error processing file:', error);
                        alert('Error processing file: ' + error.message);
                        this.loading = false;
                        this.render();
                    }
                };
                reader.readAsArrayBuffer(file);
            },

            normalizeString(str) {
                if (!str) return '';
                return str.toString().toLowerCase().trim().replace(/[^a-z0-9]/g, '');
            },

            normalizeAddress(str) {
                if (!str) return '';
                
                // Convert to lowercase and normalize whitespace
                let normalized = str.toString().toLowerCase().trim();
                
                // Normalize common street abbreviations
                const abbreviations = {
                    'highway': 'hwy',
                    'hwy': 'hwy',
                    'road': 'rd',
                    'rd': 'rd',
                    'street': 'st',
                    'st': 'st',
                    'avenue': 'ave',
                    'ave': 'ave',
                    'drive': 'dr',
                    'dr': 'dr',
                    'lane': 'ln',
                    'ln': 'ln',
                    'court': 'ct',
                    'ct': 'ct',
                    'circle': 'cir',
                    'cir': 'cir',
                    'boulevard': 'blvd',
                    'blvd': 'blvd',
                    'place': 'pl',
                    'pl': 'pl',
                    'trail': 'trl',
                    'trl': 'trl',
                    'parkway': 'pkwy',
                    'pkwy': 'pkwy',
                    'way': 'way',
                    'loop': 'loop',
                    'apartment': 'apt',
                    'apt': 'apt',
                    'unit': 'unit'
                };
                
                // Replace abbreviations
                Object.keys(abbreviations).forEach(key => {
                    const regex = new RegExp('\\b' + key + '\\b', 'gi');
                    normalized = normalized.replace(regex, abbreviations[key]);
                });
                
                // Remove all non-alphanumeric characters
                return normalized.replace(/[^a-z0-9]/g, '');
            },

            matchParentsToVoters(parents = null) {
                const parentsToMatch = parents || this.parentData;
                
                this.parentData = parentsToMatch.map((parent, index) => {
                    // Parse Contact Name (format: "Last, First" or "Last, First Middle")
                    const contactName = parent['Contact Name'] || '';
                    const nameParts = contactName.split(',').map(s => s.trim());
                    const parentLastName = nameParts[0] || '';
                    const parentFirstName = nameParts[1] ? nameParts[1].split(' ')[0] : '';
                    
                    const parentContactAddress = parent['Contact Address'] || '';
                    const parentCityStateZip = parent['City-State-Zip'] || '';
                    const overrideRegistered = (parent['Override Registered'] || '').toLowerCase() === 'yes';
                    
                    // Parse parent address
                    const parentParsed = this.parseParentAddress(parentContactAddress, parentCityStateZip);
                    
                    let isRegistered = false;
                    let matchedVoter = null;
                    let matchMethod = '';
                    let matchConfidence = 0;

                    // Check manual override first
                    if (overrideRegistered) {
                        isRegistered = true;
                        matchMethod = 'Manual Override';
                        matchConfidence = 100;
                    } else {
                        // PRIORITY 1: Address-based matching with fuzzy logic
                        if (parentParsed.streetNumber) {
                            const lookupKey = parentParsed.streetNumber;
                            const candidates = this.voterIndex[lookupKey] || [];
                            
                            let bestMatch = null;
                            let bestSimilarity = 0;
                            
                            for (const candidate of candidates) {
                                // Calculate street name similarity
                                const similarity = this.stringSimilarity(
                                    parentParsed.streetName, 
                                    candidate.parsed.streetName
                                );
                                
                                if (similarity > bestSimilarity) {
                                    bestSimilarity = similarity;
                                    bestMatch = candidate;
                                }
                            }
                            
                            // HIGH CONFIDENCE: 95%+ similarity
                            if (bestSimilarity >= 95) {
                                isRegistered = true;
                                matchedVoter = bestMatch.voter;
                                matchMethod = bestSimilarity === 100 ? 'Address Match (Exact)' : `Address Match (${bestSimilarity}% similar)`;
                                matchConfidence = bestSimilarity;
                            }
                            // MEDIUM CONFIDENCE: 85-94% similarity
                            else if (bestSimilarity >= 85) {
                                isRegistered = true;
                                matchedVoter = bestMatch.voter;
                                matchMethod = `Address Match (${bestSimilarity}% fuzzy)`;
                                matchConfidence = bestSimilarity;
                            }
                        }
                        
                        // PRIORITY 2: Name + City fallback (only if address didn't match)
                        if (!isRegistered) {
                            const parentLastNorm = this.normalizeString(parentLastName);
                            const parentFirstNorm = this.normalizeString(parentFirstName);
                            const parentCity = this.normalizeString(parentParsed.city);
                            
                            // Search through voters
                            for (const voter of this.voterData) {
                                const voterLastNorm = this.normalizeString(voter.lastName || '');
                                const voterFirstNorm = this.normalizeString(voter.firstName || '');
                                const voterCity = this.normalizeString(this.parseVoterAddress(voter).city);
                                
                                // Exact name + city match
                                if (parentLastNorm && voterLastNorm && parentLastNorm === voterLastNorm &&
                                    parentFirstNorm && voterFirstNorm && parentFirstNorm === voterFirstNorm &&
                                    parentCity && voterCity && parentCity === voterCity) {
                                    isRegistered = true;
                                    matchedVoter = voter;
                                    matchMethod = 'Name + City Match';
                                    matchConfidence = 80;
                                    break;
                                }
                            }
                        }
                        
                        // PRIORITY 3: Name + Street Number (partial address)
                        if (!isRegistered && parentParsed.streetNumber) {
                            const parentLastNorm = this.normalizeString(parentLastName);
                            const parentFirstNorm = this.normalizeString(parentFirstName);
                            const lookupKey = parentParsed.streetNumber;
                            const candidates = this.voterIndex[lookupKey] || [];
                            
                            for (const candidate of candidates) {
                                const voterLastNorm = this.normalizeString(candidate.voter.lastName || '');
                                const voterFirstNorm = this.normalizeString(candidate.voter.firstName || '');
                                
                                // Name match + same street number
                                if (parentLastNorm && voterLastNorm && parentLastNorm === voterLastNorm &&
                                    parentFirstNorm && voterFirstNorm && parentFirstNorm === voterFirstNorm) {
                                    isRegistered = true;
                                    matchedVoter = candidate.voter;
                                    matchMethod = 'Name + Street# Match';
                                    matchConfidence = 75;
                                    break;
                                }
                            }
                        }
                    }

                    return {
                        id: index,
                        firstName: parentFirstName,
                        lastName: parentLastName,
                        fullAddress: parentContactAddress,
                        cityStateZip: parentCityStateZip,
                        phone: parent['Contact Phone'] || '',
                        email: parent['Contact Email'] || '',
                        studentName: parent['Student Name'] || '',
                        relationship: parent['Relationship'] || '',
                        isRegistered,
                        matchedVoter,
                        matchMethod,
                        matchConfidence,
                        overrideRegistered,
                        ...parent
                    };
                });

                this.updateStats();
                this.applyFilters();
            },

            parseParentAddress(contactAddress, cityStateZip) {
                // Parse "5817 Highway 9" or "207 Vaughn Road" and "Benton, AR 72019"
                // Strip apartment/unit numbers (Apt B, Unit 4, #205, etc)
                let cleanAddress = (contactAddress || '').trim()
                    .replace(/,?\s*(apt|apartment|unit|#|ste|suite)\s*[a-z0-9-]*/gi, '');
                
                const addressParts = cleanAddress.split(/\s+/);
                const streetNumber = addressParts[0] || '';
                const streetName = addressParts.slice(1).join(' ');
                
                // Parse "Benton, AR 72019" or "Hot Springs, AR 71901"
                const cityStateZipParts = (cityStateZip || '').split(',');
                const city = (cityStateZipParts[0] || '').trim();
                const stateZip = (cityStateZipParts[1] || '').trim().split(/\s+/);
                const zip = (stateZip[1] || '').trim();
                
                return {
                    streetNumber: this.normalizeString(streetNumber),
                    streetName: this.normalizeAddress(streetName),
                    city: city,
                    zip: zip
                };
            },

            parseVoterAddress(voter) {
                // Handle both Saline and Garland county formats
                const streetNumber = this.normalizeString(
                    voter['text_res_address_nbr'] || 
                    voter['text_registrant_res_street_nbr'] || 
                    ''
                );
                
                // Get street name and type from the actual columns
                const streetName = voter['text_street_name'] || '';
                const streetType = voter['cde_street_type'] || 
                    voter['cde_street_dir_suffix'] || '';
                
                // Combine street name and type, then normalize
                const fullStreetName = this.normalizeAddress([streetName, streetType].filter(Boolean).join(' '));
                
                const city = voter['text_res_city'] || voter['text_mail_city'] || '';
                const zip = voter['text_res_zip5'] || voter['text_mail_zip'] || voter['text_res_zip'] || '';
                
                return {
                    streetNumber: streetNumber,
                    streetName: fullStreetName,
                    city: city,
                    zip: zip
                };
            },

            addressesMatch(parent, voter) {
                // Match if Street Number + Street Name match (ZIP removed)
                if (!parent.streetNumber || !parent.streetName) return false;
                if (!voter.streetNumber || !voter.streetName) return false;
                
                return parent.streetNumber === voter.streetNumber &&
                       parent.streetName === voter.streetName;
            },

            applyFilters() {
                let filtered = this.viewMode === 'voters' ? this.voterData : this.parentData;

                if (this.searchTerm) {
                    const searchLower = this.searchTerm.toLowerCase();
                    filtered = filtered.filter(item => 
                        Object.values(item).some(val => 
                            String(val).toLowerCase().includes(searchLower)
                        )
                    );
                }

                if (this.viewMode === 'voters' && this.countyFilter !== 'all') {
                    filtered = filtered.filter(v => v.county === this.countyFilter);
                }

                if (this.viewMode === 'parents') {
                    if (this.registeredFilter === 'registered') {
                        filtered = filtered.filter(p => p.isRegistered);
                    } else if (this.registeredFilter === 'unregistered') {
                        filtered = filtered.filter(p => !p.isRegistered);
                    }
                }

                this.filteredData = filtered;
            },

            exportToExcel() {
                const dataToExport = this.viewMode === 'voters' ? this.filteredData : this.filteredData.map(p => {
                    const exported = {...p};
                    delete exported.matchedVoter;
                    exported['Registration Status'] = p.isRegistered ? 'REGISTERED' : 'NOT REGISTERED';
                    if (p.matchedVoter) {
                        exported['Matched Voter'] = `${p.matchedVoter['nam_first'] || p.matchedVoter['First Name'] || ''} ${p.matchedVoter['nam_text'] || p.matchedVoter['Last Name'] || ''}`;
                    }
                    return exported;
                });
                
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, this.viewMode === 'voters' ? 'Voters' : 'Parents');
                XLSX.writeFile(wb, `fountain_lake_${this.viewMode}_export.xlsx`);
            },

            render() {
                const app = document.getElementById('app');
                
                if (this.loading) {
                    app.innerHTML = `
                        <div class="flex items-center justify-center h-screen bg-gray-50">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-900 mx-auto mb-4"></div>
                                <p class="text-gray-600 mb-2">${this.loadingMessage}</p>
                                <div class="w-64 h-2 bg-gray-200 rounded-full mx-auto overflow-hidden">
                                    <div class="h-full bg-purple-900 transition-all duration-300" style="width: ${this.loadingProgress}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                const headers = this.viewMode === 'voters' && this.voterData.length > 0 
                    ? Object.keys(this.voterData[0]).filter(key => !['id', 'county'].includes(key)).slice(0, 7)
                    : this.parentData.length > 0 
                    ? Object.keys(this.parentData[0]).filter(key => !['id', 'isRegistered', 'matchedVoter'].includes(key)).slice(0, 7)
                    : [];

                app.innerHTML = `
                    <div class="bg-gradient-to-r from-purple-900 to-gray-800 text-white shadow-lg">
                        <div class="max-w-7xl mx-auto px-6 py-8">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-4xl font-bold tracking-tight">Fountain Lake School District</h1>
                                    <p class="text-purple-200 text-lg mt-2">Voter Database & Registration Tracker</p>
                                </div>
                                <div class="hidden md:block">
                                    <div class="bg-white bg-opacity-10 rounded-lg px-6 py-3 backdrop-blur-sm">
                                        <p class="text-sm text-purple-200">Campaign Dashboard</p>
                                        <p class="text-2xl font-bold">${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto px-6 py-6">
                        <!-- Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                            <div class="bg-white rounded-lg shadow p-4">
                                <p class="text-sm text-gray-600">Total Voters</p>
                                <p class="text-2xl font-bold text-gray-900">${this.stats.totalVoters.toLocaleString()}</p>
                            </div>
                            <div class="bg-white rounded-lg shadow p-4">
                                <p class="text-sm text-gray-600">Saline County</p>
                                <p class="text-2xl font-bold text-gray-900">${this.stats.salineVoters.toLocaleString()}</p>
                            </div>
                            <div class="bg-white rounded-lg shadow p-4">
                                <p class="text-sm text-gray-600">Garland County</p>
                                <p class="text-2xl font-bold text-gray-900">${this.stats.garlandVoters.toLocaleString()}</p>
                            </div>
                            <div class="bg-white rounded-lg shadow p-4">
                                <p class="text-sm text-gray-600">Total Parents</p>
                                <p class="text-2xl font-bold text-gray-900">${this.stats.totalParents.toLocaleString()}</p>
                            </div>
                            <div class="bg-white rounded-lg shadow p-4">
                                <p class="text-sm text-gray-600">Registered Parents</p>
                                <p class="text-2xl font-bold text-green-700">${this.stats.registeredParents.toLocaleString()}</p>
                                <p class="text-xs text-gray-500 mt-1">${this.stats.totalParents > 0 ? Math.round((this.stats.registeredParents / this.stats.totalParents) * 100) : 0}% registered</p>
                            </div>
                            <div class="bg-white rounded-lg shadow p-4">
                                <p class="text-sm text-gray-600">Unregistered Parents</p>
                                <p class="text-2xl font-bold text-orange-700">${this.stats.unregisteredParents.toLocaleString()}</p>
                                <p class="text-xs text-gray-500 mt-1">${this.stats.totalParents > 0 ? Math.round((this.stats.unregisteredParents / this.stats.totalParents) * 100) : 0}% unregistered</p>
                            </div>
                        </div>

                        <!-- Registration Rate Banner -->
                        ${this.stats.totalParents > 0 ? `
                        <div class="bg-gradient-to-r from-purple-900 to-purple-700 rounded-lg shadow-lg p-6 mb-6 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90 mb-1">Parent Registration Rate</p>
                                    <p class="text-4xl font-bold">${Math.round((this.stats.registeredParents / this.stats.totalParents) * 100)}%</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm opacity-90">${this.stats.registeredParents.toLocaleString()} of ${this.stats.totalParents.toLocaleString()} parents registered</p>
                                    <p class="text-sm font-semibold mt-1">${this.stats.unregisteredParents.toLocaleString()} parents still need to register</p>
                                </div>
                            </div>
                            <div class="mt-4 bg-white bg-opacity-20 rounded-full h-3 overflow-hidden">
                                <div class="bg-white h-full rounded-full transition-all duration-500" style="width: ${Math.round((this.stats.registeredParents / this.stats.totalParents) * 100)}%"></div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- View Toggle -->
                        <div class="bg-white rounded-lg shadow p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                <button onclick="App.setViewMode('voters')" class="px-6 py-3 rounded-lg font-semibold transition ${this.viewMode === 'voters' ? 'bg-purple-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    Voter Database (${this.stats.totalVoters.toLocaleString()})
                                </button>
                                <button onclick="App.setViewMode('parents')" class="px-6 py-3 rounded-lg font-semibold transition ${this.viewMode === 'parents' ? 'bg-purple-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    Parent Database (${this.stats.totalParents.toLocaleString()})
                                </button>
                                <button onclick="App.setViewMode('map')" class="px-6 py-3 rounded-lg font-semibold transition ${this.viewMode === 'map' ? 'bg-purple-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    üìç Map View
                                </button>
                            </div>
                        </div>

                        <!-- Upload -->
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <h2 class="text-xl font-bold mb-4">Data Sources</h2>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <p class="text-sm text-purple-900"><strong>‚úì All data loads automatically</strong> from Google Sheets</p>
                                <ul class="text-xs text-purple-800 mt-2 ml-4 list-disc">
                                    <li>Saline County Voters</li>
                                    <li>Garland County Voters</li>
                                    <li>Parent Database (matched against both counties)</li>
                                </ul>
                                <p class="text-xs text-purple-800 mt-2">Data updates when you refresh the page</p>
                            </div>
                        </div>

                        <!-- Search & Filter -->
                        ${this.viewMode !== 'map' ? `
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                                    <input type="text" id="search-input" placeholder="Search..." value="${this.searchTerm}" oninput="App.setSearch(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                ${this.viewMode === 'voters' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">County</label>
                                        <select onchange="App.setCountyFilter(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                            <option value="all" ${this.countyFilter === 'all' ? 'selected' : ''}>All Counties</option>
                                            <option value="Saline" ${this.countyFilter === 'Saline' ? 'selected' : ''}>Saline County</option>
                                            <option value="Garland" ${this.countyFilter === 'Garland' ? 'selected' : ''}>Garland County</option>
                                        </select>
                                    </div>
                                ` : `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Registration Status</label>
                                        <select onchange="App.setRegisteredFilter(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                            <option value="all" ${this.registeredFilter === 'all' ? 'selected' : ''}>All Parents</option>
                                            <option value="registered" ${this.registeredFilter === 'registered' ? 'selected' : ''}>Registered Only</option>
                                            <option value="unregistered" ${this.registeredFilter === 'unregistered' ? 'selected' : ''}>Unregistered Only</option>
                                        </select>
                                    </div>
                                `}
                                <div class="flex items-end">
                                    <button onclick="App.exportToExcel()" class="w-full px-4 py-2 bg-purple-900 text-white rounded-lg hover:bg-purple-800 transition">Export to Excel</button>
                                </div>
                            </div>
                            <div class="mt-4" id="stats-container">
                                ${this.getStatsHTML()}
                            </div>
                        </div>
                        ` : `
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <h2 class="text-lg font-bold mb-4">Map Controls</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Show on Map</label>
                                    <select onchange="App.setMapFilter(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="all" ${this.mapFilter === 'all' ? 'selected' : ''}>All Parents</option>
                                        <option value="registered" ${this.mapFilter === 'registered' ? 'selected' : ''}>Registered Only</option>
                                        <option value="unregistered" ${this.mapFilter === 'unregistered' ? 'selected' : ''}>Unregistered Only</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="App.toggleHeatmap()" class="w-full px-4 py-2 ${this.showHeatmap ? 'bg-purple-900 text-white' : 'bg-gray-200 text-gray-700'} rounded-lg hover:bg-purple-800 hover:text-white transition">
                                        ${this.showHeatmap ? 'üî• Hide Heatmap' : 'üî• Show Heatmap'}
                                    </button>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="App.exportToExcel()" class="w-full px-4 py-2 bg-purple-900 text-white rounded-lg hover:bg-purple-800 transition">Export to Excel</button>
                                </div>
                            </div>
                            <div class="mt-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <p class="text-sm font-semibold text-gray-700 mb-2">Map Legend:</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                                    <div class="flex items-center gap-2">
                                        <span style="display: inline-block; width: 16px; height: 16px; background-color: #16a34a; border-radius: 50%; border: 2px solid white;"></span>
                                        <span class="text-gray-700"><strong>Green:</strong> Registered (address match)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span style="display: inline-block; width: 16px; height: 16px; background-color: #eab308; border-radius: 50%; border: 2px solid white;"></span>
                                        <span class="text-gray-700"><strong>Yellow:</strong> Registered (name match)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span style="display: inline-block; width: 16px; height: 16px; background-color: #dc2626; border-radius: 50%; border: 2px solid white;"></span>
                                        <span class="text-gray-700"><strong>Red:</strong> Not registered</span>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600 mt-3">Click any marker to see parent details. Showing first 200 parents for performance.</p>
                            </div>
                        </div>
                        `}

                        <!-- Data Table / Map -->
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            ${this.viewMode === 'map' ? `
                                <div id="map"></div>
                            ` : `
                                <div class="overflow-x-auto" id="table-container">
                                    ${this.getTableHTML()}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            setViewMode(mode) {
                this.viewMode = mode;
                this.applyFilters();
                this.render();
                
                // Initialize or refresh map when switching to map view
                if (mode === 'map') {
                    setTimeout(() => {
                        // Always reinitialize the map when switching to map view
                        // because the DOM container was destroyed and recreated
                        this.map = null; // Force recreation
                        this.initMap();
                    }, 100);
                }
            },

            setSearch(term) {
                this.searchTerm = term;
                this.applyFilters();
                this.renderTable();
            },

            setCountyFilter(filter) {
                this.countyFilter = filter;
                this.applyFilters();
                this.renderTable();
            },

            setRegisteredFilter(filter) {
                this.registeredFilter = filter;
                this.applyFilters();
                this.renderTable();
            },

            renderTable() {
                const tableContainer = document.getElementById('table-container');
                const statsContainer = document.getElementById('stats-container');
                
                if (!tableContainer) {
                    this.render();
                    return;
                }

                // Update stats
                statsContainer.innerHTML = this.getStatsHTML();
                
                // Update table
                tableContainer.innerHTML = this.getTableHTML();
            },

            getStatsHTML() {
                const legend = this.viewMode === 'parents' ? `
                    <div class="mt-3 bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <p class="text-sm font-semibold text-gray-700 mb-2">What do these symbols mean?</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 text-xs">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl text-green-600">‚úì</span>
                                <span class="text-gray-700"><strong>Green Check:</strong> Registered (address matched)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl text-yellow-600">‚úì</span>
                                <span class="text-gray-700"><strong>Yellow Check:</strong> Registered (name matched)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl text-red-600">‚úó</span>
                                <span class="text-gray-700"><strong>Red X:</strong> Not registered</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-lg">‚ö†Ô∏è</span>
                                <span class="text-gray-700"><strong>Warning:</strong> Similar address found</span>
                            </div>
                        </div>
                    </div>
                ` : '';
                
                return `
                    <p class="text-sm text-gray-600">Showing ${this.filteredData.length.toLocaleString()} of ${(this.viewMode === 'voters' ? this.voterData.length : this.parentData.length).toLocaleString()} records</p>
                    ${legend}
                `;
            },

            getTableHTML() {
                if (this.viewMode === 'parents') {
                    return `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registered</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${this.filteredData.slice(0, 100).map(parent => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-center">
                                            ${parent.isRegistered ? 
                                                `<div class="flex items-center justify-center gap-1">
                                                    <span class="text-2xl ${parent.matchConfidence >= 95 ? 'text-green-600' : 'text-yellow-600'}">‚úì</span>
                                                    ${parent.matchMethod === 'Manual Override' ? 
                                                        '<span class="text-xs text-blue-600" title="Manual Override">üë§</span>' : 
                                                     parent.matchConfidence < 95 && parent.matchConfidence >= 85 ?
                                                        '<span class="text-xs text-yellow-600" title="Fuzzy Match">‚ö†Ô∏è</span>' :
                                                     parent.matchMethod.includes('Name') ?
                                                        '<span class="text-xs text-orange-600" title="Name-based Match">üë§</span>' : ''}
                                                </div>` : 
                                                '<span class="text-2xl text-red-600">‚úó</span>'
                                            }
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${parent.firstName || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${parent.lastName || '-'}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900" style="max-width: 250px; white-space: normal;">
                                            ${parent.fullAddress || '-'}
                                            ${parent.cityStateZip ? '<br><span class="text-gray-600 text-xs">' + parent.cityStateZip + '</span>' : ''}
                                            ${parent.matchMethod ? '<br><span class="text-gray-500 text-xs italic">' + parent.matchMethod + '</span>' : ''}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${parent.phone || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${parent.email || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${parent.studentName || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${this.filteredData.length > 100 ? '<div class="bg-gray-50 px-6 py-4 text-sm text-gray-600 text-center">Showing first 100 results. Use filters to narrow your search or export all data.</div>' : ''}
                    `;
                }
                
                // Voter view
                return `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">County</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Middle Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precinct</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${this.filteredData.slice(0, 100).map(item => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-semibold rounded ${item.county === 'Saline' ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800'}">
                                            ${item.county}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.firstName || '-'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.middleName || '-'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.lastName || '-'}</td>
                                    <td class="px-6 py-4 text-sm text-gray-900" style="max-width: 250px; white-space: normal;">${item.fullAddress || '-'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <span class="px-2 py-1 text-xs font-medium rounded ${item.status === 'REG' ? 'bg-green-100 text-green-800' : item.status === 'N/A' ? 'bg-gray-100 text-gray-600' : 'bg-yellow-100 text-yellow-800'}">
                                            ${item.status}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.age}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.precinct || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${this.filteredData.length > 100 ? '<div class="bg-gray-50 px-6 py-4 text-sm text-gray-600 text-center">Showing first 100 results. Use filters to narrow your search or export all data.</div>' : ''}
                `;
            },
        };

        // Initialize app
        App.init();
    </script>
</body>
</html>
